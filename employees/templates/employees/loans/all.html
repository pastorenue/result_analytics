{% extends "employees/employees.html" %}
{% load humanize search_tags %}

{% block title %}
{% ifequal employee.user user %}My Loans{% else %}{{ employee.full_name }}'s Loans{% endifequal %}
{% endblock %}

{% block breadcrumbs %}
<a href="{% url 'employees_list' %}">All employees</a> &raquo;
<a href="{{ employee.get_absolute_url }}">{{ employee.full_name }}</a> &raquo; Loans
{% endblock %}

{% block content %}
<h2>
	{% ifequal employee.user user %}My Loans{% else %}{{ employee.full_name }}'s Loans{% endifequal %}
</h2>

<table class="summary-pane" style="width: 35%">
    <tbody>
        <tr>
            <td style="text-align: center; width: 50%">
                <span class="big">{{ monthly_deduction|floatformat:2|intcomma }}</span> total monthly deductions
            </td>
            <td style="text-align: center; width: 50%">
                <span class="big">{{ liability|floatformat:2|intcomma }}</span> total amount unpaid
            </td>
        </tr>
    </tbody>
</table>

<table class="drop-shadow show-current-row" style="width: 100%">
    <thead>
        <tr>
            <th scope="col">Loan</th>
            <th scope="col">Principal</th>
            <th scope="col">Interest (%)</th>
            <th scope="col">Status</th>
            <th scope="col">Monthly deduction</th>
			<th scope="col">Amount unpaid</th>
            <th scope="col">Deductions</th>
        </tr>
    </thead>
    <tbody>
        {% for loan in loan_list %}
		<tr class="{% cycle 'odd' 'even' as rowcolors %}">
			<td>{{ loan.loan_type }}</td>
			<td>{{ loan.amount|floatformat:2|intcomma }}</td>
			<td>{{ loan.loan_type.interest_rate|floatformat:2 }}</th>
			<td>{{ loan.get_status_display }}</td>
			<td class="amount">{{ loan.monthly_deduction|floatformat:2|intcomma }}</td>
			<td class="amount">{{ loan.balance|default_if_none:0|floatformat:2|intcomma }}</td>
			<td style="text-align: center">
                <div class="has-tip">
                    <a href="#t-payments-{{ loan.pk }}" class="show-tip" data-tip-position="bottom center" data-tip-offset-y="5">{{ loan.payments_made }} of {{ loan.deductions }}</a>
                    {% with loan.get_status_display as loan_status %}
                    <div id="t-payments-{{ loan.pk }}" class="tip-content">
                        {% for payment in loan.payments.all %}
                            <strong>{{ payment.amount|floatformat:2|intcomma }}</strong>
                            {% if payment.paid %}paid{% else %}due{% endif %} on <strong>{{ payment.date_scheduled|date:"jS M Y" }}</strong>
                            <br />
                        {% empty %}
                            {% if loan_status == "Pending" %}
                                This loan hasn't been approved yet.
                            {% elif loan_status == "Running" %}
                                Payment for this loan will start on the {{ loan.start_deductions|date:"jS \o\f F, Y" }}.
                            {% else %}
                                No payments have been made for this loan.
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endwith %}
                </div>
			</td>
		</tr>
        {% empty %}
		<tr>
			<td colspan="7">
				{% ifequal status "all" %}You haven't taken any loans.{% else %}You don't have any {{ status|title }} loans.{% endifequal %}
			</td>
		</tr>
        {% endfor %}
    </tbody>
</table>
{% paginate %}
<a href="{% url 'employees_new_loan' employee_id=employee.pk %}">
    <i class="fa fa-fw fa-plus-circle"></i>
    Apply for a Loan
</a>
{% endblock %}
